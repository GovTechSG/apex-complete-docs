# JWT Authentication

APEX Supports JWT Authentication as a secure means to secure the API transaction between a Consumer (API Requester) and Publisher (owner of API endpoint).

## Terminology

Publisher - This is the owner of the API endpoint hosted on APEX, which may be an Agency.

Developer/Consumer - This is the developer of the application which will use (or consume) the API belonging to the Publisher.

Key set - a pair of public and private key generated by the Developer.

## Prerequisites-API Endpoint URL

The Developer will have to get the API Endpoint URL from the Publisher. This will be the API which the API request is to be made to. (eg. <https://public-stg.api.gov.sg/agency/api>)

## Prerequisites-API Key(s)

The Developer will have to create the respective Application(s) to subscribe to the API(s) provided by the Publisher. In the Authentication section of the Application, the API Key can be generated (eg. xxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxx).

Please note that 2 API Keys will be required for a bridging API. The Publisher should inform you if your API is a bridging API.

> ![Image](./_assets/api-key-portal-1.png) ![Image](./_assets/api-key-portal-2.png) _For API Developer Portal Users_

> ![Image](./_assets/api-key-manager-1.png) _For API Manager Users_

## Prerequisites-JWKS Endpoint

An introduction to JWK and JWKS can be found [here](sections/auth/jwks).

The Developer will have to generate a JSON Web Key (JWK) set for signing their authorization header, of an Elliptical Curve P-256 key set (ES256).

With the **public key** generated, the developer will have to either,

- Publish a JWKS (JSON Web Key Set) endpoint ([RFC7517](https://www.rfc-editor.org/rfc/rfc7517#appendix-A.1)) in the Endian [format](#example-of-jwks) typically in the URL of https://your-domain/.well-known/jwks.json, or
- In the APEX API Portal or API Manager, provide a string text of JWKS in the same [format](#example-of-jwks) when creating the APEX Application.

Do note that your key ID (kid) is used to identify your signing key in case more than 1 key exists in the JWKS (such as for purposes of key rotation).

Usually the key/value pairs of "**_use_**", "**_kid_**" will have to be appended to your key generated by a library.

A commerical service such as [auth0](https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-sets#:~:text=The%20JSON%20Web%20Key%20Set,signing%20JWTs%3A%20RS256%20and%20HS256.) may can help with the hosting of the JWKS keys.

Do take note that if JWKS endpoint is specified, the user may need to validate that [APEX has sufficient outwards connectivity to the JWKS endpoint](sections/troubleshooting/network) and using [valid CA certificate authority](sections/faqs/trusted-cert-authorities).

## Example of JWKS Endpoint

Please refer [here](sections/auth/jwks#example-of-jwks-endpoint) for more information.

## Utilizing JWKS endpoint in the Intranet

Please refer [here](sections/auth/jwks#utilizing-jwks-endpoint-in-the-intranet) for more information.

## Generating JWKS

Please refer [here](sections/auth/jwks#generating-jwks) for more information.

Please refer [here](sections/auth/jwt-sample) for code samples.

## API Payload Hash

If the API method is POST, PUT or PATCH, the API payload binary will have to be hashed using SHA-256. The Payload should be standardized [as below](#apex-standardized-json-payload) (for JSON payload).

### _APEX Standardized JSON Payload_

For purposes of consistency of SHA256 data hash across different OS to ease troubleshooting, API payload containing JSON object and data shall be serialized into a single string, and hashed, before sending the serialized string as the payload for the API request.

The serialized string shall not have any white spaces, tabs, carriage returns ('\r' or 0x0D) or linefeed ('\n' or 0x0A) before or after any of the structural characters of JSON (ie. left square bracket '[', left curly bracket '{', right square bracket ']', right curly bracket '}', colon ':', comma ',').

One might describe this JSON string as "without formatting" or compressed.
This is as different operating systems and applications may parse different formatting characters differently (eg. Windows Servers might treat a new line as CRLF ('\r\n' or 0x0D 0x0A) while UNIX-based systems might treat a new line as LF ('\n' or 0x0A) ).

```JSON
An example of an APEX standardized JSON string is:

{"Image":{"Width":800,"Height":600,"Title":"View from 15th Floor","Thumbnail":{"Url":"http://www.example.com/image/481989943","Height": 125,"Width":100},"Animated":false,"IDs":[116,943,234,38793]}}
```

### _APEX Standardized SOAP Payload_

For purposes of consistency of SHA256 data hash across different OS to ease troubleshooting, SOAP payload shall be serialized into a single string without any Carriage Return and Line Feed. These should be removed: CRLF ('\r\n' or 0x0D 0x0A) and LF ('\n' or 0x0A) and it is recommended to use UTF-8.

The resultant text is hashed, before sending the serialized string as the payload for the API request.

```xml
An example of an APEX standardized SOAP string is:

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns="https://www.w3schools.com/xml/"><soapenv:Header/><soapenv:Body><ns:CelsiusToFahrenheit><!--Optional:--><ns:Celsius>23</ns:Celsius></ns:CelsiusToFahrenheit></soapenv:Body></soapenv:Envelope>
```

## Generating JWT

The JWT can be generated using common libraries available based on RFC7519 with the following claims below and signed using either RS256 or ES256 with the Developer's private key.

| S/No | JWT Claim | Comments                                                                                                                                                                                                                                                                                                           |
| ---- | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1    | alg       | This should be '**_ES256_**' only.                                                                                                                                                                                                                                                                                 |
| 2    | typ       | Only '**_JWT_**' is accepted.                                                                                                                                                                                                                                                                                      |
| 3    | kid       | This is the key ID of the public key used to validate signature. APEX recommends monthly key rotation of the signing key. (eg. **_apex-example_**)                                                                                                                                                                 |
| 4    | iat       | This is the Unix epoch time in seconds issued at the of API call. The time zone is in UTC. This may be generated by the signing library. While **_nbf_** claim is not required, **_iat_** will be inspected that it is not in the future as compared to APEX's date/time, which is synchronized to AWS NTP server. |
| 5    | exp       | This is the Unix epoch time in seconds of the expiry time of this JWT. The time zone is in UTC. The time cannot be more than 180 seconds from the **_iat_**.                                                                                                                                                       |
| 6    | jti       | This is a random text string (nonce) of at least 40 characters. A random UUIDv4 generator is recommended to be used to generate this.                                                                                                                                                                              |
| 7    | iss       | This is your [API Key(s)](#prerequisites-api-keys) obtained above (eg. xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxx and should be delimited by comma '**_,_**' if there are 2 keys (eg. xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxx,yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyy).                                                           |
| 8    | aud       | This should match the [API endpoint URL](#prerequisites-api-endpoint-url), eg. **_https://public-stg.api.gov.sg/agency/api_**. Do note that query parameters are NOT to be included here.                                                                                                                          |
| 9    | sub       | This is the method of the API (eg. **_POST_**)                                                                                                                                                                                                                                                                     |
| 10   | data      | This is the SHA-256 [API Payload Hash](#api-payload-hash) of the payload of API.(eg. SHA-256 hash of **_{"payload":"data"}_** is **_cc575c4ed557481e31d9a2a0580bc464e84b3a79c5fc94e4fd94ba33b3e54dbc_**                                                                                                            |

Please see [here](sections/auth/jwt-sample#jwt-authentication) for sample codes to generate the JWT.

## Authorization Header

The developer will have to attach the JWT to the **x-apex-jwt** header. The JWT can be tested with the [Hello World! API](sections/auth/jwt-hello-world) beforehand.

```
POST /agency/api
Host: public-stg.api.gov.sg
x-apex-jwt: eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwZXgtZXhhbXBsZSJ9.eyJkYXRhIjoiY2M1NzVjNGVkNTU3NDgxZTMxZDlhMmEwNTgwYmM0NjRlODRiM2E3OWM1ZmM5NGU0ZmQ5NGJhMzNiM2U1NGRiYyIsImlhdCI6MTY2NzAyMDM2MSwiZXhwIjoxNjY3MDIwNTQxLCJhdWQiOiJodHRwczovL3B1YmxpYy1zdGcuYXBpLmdvdi5zZy9hZ2VuY3kvYXBpIiwiaXNzIjoieHh4eHh4eHgteHh4eC14eHh4LXh4eHgteHh4eHh4eHh4eHgseXl5eXl5eXkteXl5eS15eXl5LXl5eXkteXl5eXl5eXl5eXkiLCJzdWIiOiJQT1NUIiwianRpIjoiZWZhNjZlMWQtNjNjMS00MGViLWFkMWMtZmVkMTQ5OGYxMWU3In0.UzQzgMlFWJ-fSbRkq7SZu0QVtzgAVpEfVtjJYls4oRgmrtNAz4Dla1J5kqBmWt2V9Q-QoBm_6r1KZZ97qZtO4Q
```

## JWK Rotation

Please refer [here](sections/auth/jwks#jwk-rotation) for more information.

## Hello World! APIs

These [APIs](sections/auth/jwt-hello-world) can be subscribed to and can help the Developer to:

- Evaluate if the JWT authentication header has been generated correctly.
- Evaluate the SHA-256 hash of the API payload binary which is sent to the API.

## Useful information

<details>
<summary>Does the "aud" claim require query parameters?</summary>

"aud" claim is defined to exclude query parameters.
</details>

<details>
<summary>Does Hello World Api exist in intranet?</summary>

Yes, Hello World exists both in internet and intranet zone, with domains public-stg.api.gov.sg and gw-stg.int.api.gov.sg.
</details>

<details>
<summary>How do we carry out rotation of keys (JWK)?</summary>

As the consumer, your application would be involved in signing of the JWT using the private key.
Generate a new key with a new Key ID and add it to the JWKS endpoint ahead of time.  When the key is rotated, sign with the key with the new Key ID.
Do note however that JWKS caching in APEX servers is 1 hour hence it is still recommended to automate this for an off-peak rotation.
</details>

<details>
<summary>How do we carry out automatic rotation of keys (JWK)?</summary>

As the consumer, your application would be involved in signing of the JWT using the private key.
Hence if your organization is able to host the public key in the form of a JWKS endpoint, you would be able to update the JWKS endpoint whenever you create a new private key for signing. Hence key rotation can be effected programatically with no human intervention.
Do note however that JWKS caching in APEX servers is 1 hour hence you would have to update the JWKS endpoint at least an hour in advance.
</details>
